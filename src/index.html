<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Nodesur</title>
  <base href="/" />
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="potroNodo.ico" />

  <!-- Tu CSS (importa el style.scss donde metiste el widget) -->
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <script>
  function toggleMenu() {
    const nav = document.querySelector('.nav-bar');
    nav.classList.toggle('open');
  }
  </script>

  <app-root></app-root>


  <script>
/* ========= EVENTOS desde Google Sheet (CSV) =========
   Columnas esperadas (minúsculas):
   titulo | fecha | hora | lugar | descripcion | link | imagen
*/
const EVENTOS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ0LUcFZC7CBPAXPPVqcHOOdlI53U5Y1b2z2F01k9KWvfPiuAJwEXoo1zIzzFPqC3N6dQOZZG90m2uC/pub?gid=0&single=true&output=csv';
const FALLBACK_EVENT_IMG = 'assets/evento-placeholder.png';

// Espera a que Angular haya renderizado la sección
(function initWhenReady(){
  const ok = document.getElementById('eventos-list');
  if (ok) loadEventos();
  else setTimeout(initWhenReady, 120); // reintenta en ~0.1s
})();

function qs(id){ return document.getElementById(id); }
const $evLoading = () => qs('eventos-loading');
const $evList    = () => qs('eventos-list');
const $evEmpty   = () => qs('eventos-vacio');

function csvToObjects(csv){
  const lines = csv.split(/\r?\n/).filter(l => l.trim());
  if (lines.length < 2) return [];
  const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
  return lines.slice(1).map(row => {
    const out = []; let buf = '', q = false;
    for (let i=0;i<row.length;i++){
      const ch = row[i];
      if (ch === '"'){ q = !q; continue; }             // manejo simple de comillas
      if (ch === ',' && !q){ out.push(buf.trim()); buf=''; }
      else buf += ch;
    }
    out.push(buf.trim());
    const obj = {};
    headers.forEach((h,i)=> obj[h] = (out[i] || '').trim());
    return obj;
  });
}

function parseDateFlexible(dStr, hStr){
  if (!dStr) return null;
  let d = new Date(dStr);                 // intenta ISO
  if (isNaN(d)){
    const m = dStr.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/); // DD/MM/YYYY
    if (m){
      const dd = +m[1], mm = +m[2]-1, yy = +m[3];
      const yyyy = yy < 100 ? 2000 + yy : yy;
      d = new Date(yyyy, mm, dd);
    }
  }
  if (isNaN(d)) return null;
  if (hStr && /^\d{1,2}:\d{2}$/.test(hStr)){
    const [hh, mi] = hStr.split(':').map(n=>+n);
    d.setHours(hh, mi||0, 0, 0);
  } else {
    d.setHours(0,0,0,0);
  }
  return d;
}
function isFutureOrToday(date){
  const t = new Date(); t.setHours(0,0,0,0);
  const d = new Date(date); d.setHours(0,0,0,0);
  return d >= t;
}
function formatDateEs(date){
  return date.toLocaleDateString('es-MX',{weekday:'short',year:'numeric',month:'short',day:'numeric'});
}

function createEventCard(ev){
  const card = document.createElement('div');
  card.className = 'resource-cardd'; // coincide con tu HTML

  const imgUrl = ev.imagen || FALLBACK_EVENT_IMG;
  if (imgUrl){
    const img = document.createElement('img');
    img.src = imgUrl; img.alt = ev.titulo || 'Evento'; img.loading='lazy';
    Object.assign(img.style,{width:'100%',display:'block',borderRadius:'10px',marginBottom:'10px'});
    card.appendChild(img);
  }

  const h3 = document.createElement('h3');
  h3.textContent = ev.titulo || 'Evento';
  card.appendChild(h3);

  const meta = document.createElement('p');
  const fechaTxt = ev._date ? formatDateEs(ev._date) : 'Fecha por definir';
  const horaTxt  = ev.hora ? ` • ${ev.hora}` : '';
  const lugarTxt = ev.lugar ? ` • ${ev.lugar}` : '';
  meta.textContent = `${fechaTxt}${horaTxt}${lugarTxt}`;
  card.appendChild(meta);

  if (ev.descripcion){
    const p = document.createElement('p');
    p.textContent = ev.descripcion;
    card.appendChild(p);
  }

  if (ev.link){
    const a = document.createElement('a');
    a.href = ev.link; a.target = '_blank'; a.rel='noopener';
    a.className = 'btn-recurso'; a.textContent = 'Ver más';
    card.appendChild(a);
  }
  return card;
}

async function loadEventos(){
  try{
    const res = await fetch(EVENTOS_CSV_URL);
    const csv = await res.text();

    let items = csvToObjects(csv).map(r => {
      r._date = parseDateFlexible(r.fecha, r.hora);
      return r;
    }).filter(r => r._date && isFutureOrToday(r._date));

    // Ordena por fecha ascendente
    items.sort((a,b) => a._date - b._date);

    // Render
    $evList().innerHTML = '';
    if (!items.length){
      $evEmpty().style.display = 'block';
      return;
    }
    const frag = document.createDocumentFragment();
    items.forEach(ev => frag.appendChild(createEventCard(ev)));
    $evList().appendChild(frag);
  } catch (e){
    console.error('Eventos: error cargando CSV', e);
    $evEmpty().style.display = 'block';
  } finally {
    $evLoading()?.remove(); // asegúrate de ocultar "Cargando..."
  }
}
</script>


<script>
const RECURSOS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTgYQaMqVgTHbQrm7yIWY55wB7aNYDsz3csJYA4JJyd6qySodXJs6GoF2aWKt_e3f9FltpLsciBvCaj/pub?gid=0&single=true&output=csv';
const FALLBACK_THUMB   = 'assets/placeholder-recurso.png';
const INITIAL_LIMIT    = 6; // 3x2 en PC

const $recLoading = document.getElementById('recursos-loading');
const $recGrid    = document.getElementById('recursos-grid');
const $recEmpty   = document.getElementById('recursos-vacio');
const $btnVerMas  = document.getElementById('recursos-ver-mas');

let recItems = [];
let expanded = false;

function csvToObjects(csv){
  const lines = csv.split(/\r?\n/).filter(l => l.trim());
  if (lines.length < 2) return [];
  const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
  return lines.slice(1).map(row => {
    const out = []; let buf = '', q = false;
    for (let i=0;i<row.length;i++){
      const ch = row[i];
      if (ch === '"'){ q = !q; continue; }
      if (ch === ',' && !q){ out.push(buf.trim()); buf=''; }
      else buf += ch;
    }
    out.push(buf.trim());
    const obj = {}; headers.forEach((h,i)=> obj[h] = (out[i]||'').trim());
    return obj;
  });
}
function ytIdFromUrl(url){
  if (!url) return null;
  const reList = [
    /youtu\.be\/([A-Za-z0-9_-]{6,})/,
    /v=([A-Za-z0-9_-]{6,})/,
    /shorts\/([A-Za-z0-9_-]{6,})/,
    /embed\/([A-Za-z0-9_-]{6,})/
  ];
  for (const re of reList){ const m = url.match(re); if (m) return m[1]; }
  return null;
}
function driveViewerUrl(url){
  return `https://drive.google.com/viewerng/viewer?embedded=true&url=${encodeURIComponent(url)}`;
}
function createCard(r){
  const tipo = (r.tipo||'').toLowerCase();
  const titulo = r.titulo || 'Recurso';
  const desc = r.descripcion || '';
  const url = r.url || '#';
  const mini = r.miniatura || '';
  const btn  = r.boton || (tipo==='video'?'Ver video': tipo==='pdf'?'Ver documento':'Ir al sitio');

  const card = document.createElement('div');
  card.className = 'resource-card';

  const h3 = document.createElement('h3'); h3.textContent = titulo;
  const p  = document.createElement('p');  p.textContent  = desc;
  card.append(h3, p);

  if (tipo === 'video'){
    const vid = ytIdFromUrl(url);
    if (vid){
      const box = document.createElement('div');
      Object.assign(box.style, {
        position:'relative', paddingBottom:'56.25%', height:'0',
        overflow:'hidden', borderRadius:'10px', marginTop:'10px',
        boxShadow:'0 4px 8px rgba(0,0,0,.2)'
      });
      const iframe = document.createElement('iframe');
      iframe.src = `https://www.youtube.com/embed/${vid}`;
      iframe.title = 'Video';
      iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
      iframe.allowFullscreen = true; iframe.frameBorder = '0';
      Object.assign(iframe.style, {position:'absolute', top:0, left:0, width:'100%', height:'100%', borderRadius:'10px'});
      box.appendChild(iframe);
      card.appendChild(box);
    }
  } else {
    const img = document.createElement('img');
    img.src = mini || FALLBACK_THUMB;
    img.alt = titulo; img.loading='lazy';
    Object.assign(img.style, {
      width:'100%', display:'block', borderRadius:'10px', marginTop:'10px',
      boxShadow:'0 4px 8px rgba(0,0,0,.2)'
    });
    card.appendChild(img);
  }

  const a = document.createElement('a');
  a.className = 'btn-recurso';
  a.textContent = btn; a.target = '_blank'; a.rel = 'noopener noreferrer';
  a.href = (tipo==='pdf' && !/\.pdf($|\?)/i.test(url)) ? driveViewerUrl(url) : url;
  card.appendChild(a);

  return card;
}
function renderRecursos(items, limit = Infinity){
  $recGrid.innerHTML = '';
  const slice = items.slice(0, limit);
  const frag = document.createDocumentFragment();
  slice.forEach(r => frag.appendChild(createCard(r)));
  $recGrid.appendChild(frag);
}
async function loadRecursos(){
  try{
    const res = await fetch(RECURSOS_CSV_URL);
    const csv = await res.text();
    recItems = csvToObjects(csv).filter(r => (r.visible || '1') !== '0');

    if (!recItems.length){ $recEmpty.style.display='block'; return; }

    renderRecursos(recItems, INITIAL_LIMIT);
    if (recItems.length > INITIAL_LIMIT) $btnVerMas.hidden = false;
  }catch(e){
    console.error('Error cargando recursos:', e);
    $recEmpty.style.display='block';
  }finally{
    $recLoading?.remove();
  }
}
$btnVerMas?.addEventListener('click', () => {
  if (!expanded){
    renderRecursos(recItems); // mostrar todos
    expanded = true;
    $btnVerMas.hidden = true;
  }
});
loadRecursos();
</script>



  <!-- ============================= -->
  <!-- BOTÓN DE AUDIO (TTS) -->
  <!-- ============================= -->
  <div class="tts-widget" aria-live="polite">
    <button class="tts-fab" id="ttsFab" aria-label="Leer en voz alta" title="Leer en voz alta">
      <i class="fa-solid fa-headphones"></i>
    </button>

    <div class="tts-menu" id="ttsMenu" role="menu" aria-hidden="true">
      <button class="tts-btn play" id="ttsPlay" role="menuitem">
        <i class="fa-solid fa-volume-high"></i>
        Escuchar página
      </button>
      <button class="tts-btn stop" id="ttsStop" role="menuitem">
        <input type="checkbox" aria-hidden="true" tabindex="-1" />
        Detener
      </button>
    </div>
  </div>

  <!-- ============================= -->
  <!-- SCRIPT TTS -->
  <!-- ============================= -->
  <script>
  (() => {
    const fab   = document.getElementById('ttsFab');
    const menu  = document.getElementById('ttsMenu');
    const play  = document.getElementById('ttsPlay');
    const stopB = document.getElementById('ttsStop');
    const widget = document.querySelector('.tts-widget');

    let speaking = false;
    let queue = [];

    // Abrir/cerrar menú
    const toggleMenu = () => {
      const isOpen = menu.classList.toggle('open');
      menu.setAttribute('aria-hidden', String(!isOpen));
    };
    fab.addEventListener('click', toggleMenu);
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.tts-widget')) {
        menu.classList.remove('open');
        menu.setAttribute('aria-hidden', 'true');
      }
    });

    // Extraer texto visible
    function getPageText() {
      const selectors = ['main','section','.section','.content','h1','h2','h3','p','li'];
      const nodes = document.querySelectorAll(selectors.join(','));
      const parts = [];
      nodes.forEach(n => {
        const style = window.getComputedStyle(n);
        if (style.display === 'none' || style.visibility === 'hidden') return;
        const t = (n.innerText || '').trim().replace(/\s+/g,' ');
        if (t) parts.push(t);
      });
      return parts.join('. ');
    }

    // Crear utterances
    function createUtterances(text, voice) {
      const chunks = text.split(/(?<=\.)\s+/g).filter(Boolean);
      return chunks.map(chunk => {
        const u = new SpeechSynthesisUtterance(chunk);
        u.voice = voice || null;
        u.lang = (voice && voice.lang) || 'es-MX';
        u.rate = 1.0; u.pitch = 1.0; u.volume = 1.0;
        u.onend = () => {
          if (queue.length && u === queue[queue.length-1]) speaking = false;
        };
        return u;
      });
    }

    function pickSpanishVoice() {
      const voices = speechSynthesis.getVoices();
      const es = voices.filter(v => v.lang && v.lang.toLowerCase().startsWith('es'));
      return es.find(v => /google|microsoft/i.test(v.name)) || es[0] || voices[0] || null;
    }

    function startReading() {
      const text = getPageText();
      if (!text) return alert('No encontré texto para leer.');
      speechSynthesis.cancel(); queue = [];
      const voice = pickSpanishVoice();
      queue = createUtterances(text, voice);
      speaking = true;
      widget.classList.add('playing');
      queue.forEach(u => speechSynthesis.speak(u));
    }

    function stopReading() {
      speaking = false; queue = [];
      speechSynthesis.cancel();
      widget.classList.remove('playing');
    }

    if (typeof speechSynthesis !== 'undefined') {
      speechSynthesis.onvoiceschanged = () => {};
    }

    play.addEventListener('click', startReading);
    stopB.addEventListener('click', stopReading);
  })();
  </script>

  <!-- ============================= -->
  <!-- Script: Eventos dinámicos CSV -->
  <!-- ============================= -->
  <script>
  // Aquí sigue tu script de eventos CSV (no lo moví)
  </script>

</body>
</html>

